<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NFC Batch Scanner</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      body {
        background: linear-gradient(135deg, #f8fafc, #eef2f7);
        min-height: 100vh;
      }
      .card {
        border-radius: 1rem;
      }
      .history-box {
        max-height: 60vh;
        overflow-y: auto;
      }
      textarea {
        resize: none;
      }
    </style>
  </head>
  <body class="p-4">
    <div class="container">
      <div class="text-center mb-4">
        <h2 class="fw-bold text-primary">üì∂ NFC Batch Scanner</h2>
        <p class="text-muted">Scan NFC tag to get batch ID & store info</p>
      </div>

      <!-- Scanner section -->
      <div class="row g-4">
        <div class="col-md-8">
          <div class="card shadow p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="fw-semibold">Scanner</h5>
              <span id="status" class="badge bg-secondary">Checking...</span>
            </div>

            <div class="mb-3">
              <button id="startBtn" class="btn btn-primary me-2">
                Start Scan
              </button>
              <button
                id="stopBtn"
                class="btn btn-outline-secondary me-2"
                disabled
              >
                Stop
              </button>
              <button id="demoBtn" class="btn btn-success">Demo Read</button>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <div class="border rounded p-3 h-100">
                  <h6 class="text-muted mb-2">Last Read</h6>
                  <p class="small text-muted mb-1">
                    Time: <span id="lastTime">-</span>
                  </p>
                  <p class="mb-1">
                    <strong>Batch ID:</strong> <span id="lastBatch">None</span>
                  </p>
                </div>
              </div>

              <div class="col-md-6">
                <form id="infoForm">
                  <div class="mb-2">
                    <label class="form-label small">Batch ID</label>
                    <input
                      id="batchId"
                      type="text"
                      class="form-control"
                      placeholder="e.g. BATCH-001"
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">Farmer / Producer</label>
                    <input
                      id="farmer"
                      type="text"
                      class="form-control"
                      placeholder="Name or farm"
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">Quantity</label>
                    <input
                      id="qty"
                      type="text"
                      class="form-control"
                      placeholder="e.g. 20 crates"
                    />
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">Notes</label>
                    <textarea
                      id="notes"
                      rows="2"
                      class="form-control"
                      placeholder="Any remarks..."
                    ></textarea>
                  </div>
                  <button type="submit" class="btn btn-primary w-100 mt-2">
                    Save Entry
                  </button>
                </form>
              </div>
            </div>

            <div class="alert alert-warning mt-3 d-none" id="noSupport">
              ‚ö†Ô∏è Web NFC not supported! Use Chrome on Android with HTTPS, or
              enter batch manually.
            </div>
          </div>
        </div>

        <!-- History section -->
        <div class="col-md-4">
          <div class="card shadow p-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="fw-semibold">History</h5>
              <div>
                <button
                  class="btn btn-sm btn-outline-secondary me-2"
                  id="exportBtn"
                >
                  Export CSV
                </button>
                <button class="btn btn-sm btn-outline-danger" id="clearBtn">
                  Clear
                </button>
              </div>
            </div>
            <div id="history" class="history-box small"></div>
          </div>
        </div>
      </div>

      <p class="text-center text-muted mt-4 small">
        Built with ‚ù§Ô∏è using Web NFC API
      </p>
    </div>

    <script>
      const statusEl = document.getElementById("status");
      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const demoBtn = document.getElementById("demoBtn");
      const noSupport = document.getElementById("noSupport");
      const batchInput = document.getElementById("batchId");
      const farmerInput = document.getElementById("farmer");
      const qtyInput = document.getElementById("qty");
      const notesInput = document.getElementById("notes");
      const form = document.getElementById("infoForm");
      const historyBox = document.getElementById("history");
      const exportBtn = document.getElementById("exportBtn");
      const clearBtn = document.getElementById("clearBtn");
      const lastBatch = document.getElementById("lastBatch");
      const lastTime = document.getElementById("lastTime");

      let supported = "NDEFReader" in window;
      let scanning = false;
      let ndef;
      let history = JSON.parse(localStorage.getItem("nfc_history_v1") || "[]");

      function saveHistory() {
        localStorage.setItem("nfc_history_v1", JSON.stringify(history));
        renderHistory();
      }

      function fmt(d) {
        return new Date(d).toLocaleString();
      }

      function renderHistory() {
        if (history.length === 0) {
          historyBox.innerHTML = '<p class="text-muted">No entries yet.</p>';
          return;
        }
        historyBox.innerHTML = history
          .map(
            (h) => `
        <div class='border rounded p-2 mb-2'>
          <div><strong>${h.batchId}</strong></div>
          <div class='text-muted'>${fmt(h.timestamp)}</div>
          <div>${h.farmer || ""} ${h.qty ? "‚Ä¢ " + h.qty : ""}</div>
          ${
            h.notes
              ? `<div class='text-muted fst-italic small'>${h.notes}</div>`
              : ""
          }
          <button class='btn btn-sm btn-link text-danger p-0 mt-1' onclick='deleteEntry(${
            h.timestamp
          })'>Delete</button>
        </div>
      `
          )
          .join("");
      }

      function deleteEntry(ts) {
        history = history.filter((h) => h.timestamp !== ts);
        saveHistory();
      }

      async function startScan() {
        if (!supported) {
          noSupport.classList.remove("d-none");
          return;
        }
        try {
          ndef = new NDEFReader();
          await ndef.scan();
          scanning = true;
          statusEl.textContent = "Scanning...";
          statusEl.className = "badge bg-success";
          startBtn.disabled = true;
          stopBtn.disabled = false;

          ndef.onreading = (event) => {
            let batchId = "";
            for (const record of event.message.records) {
              if (record.recordType === "text") {
                batchId = new TextDecoder(record.encoding).decode(record.data);
              }
            }
            if (!batchId)
              batchId = "unknown-" + Math.random().toString(36).slice(2, 8);
            handleRead(batchId);
          };

          ndef.onreadingerror = () => alert("Read error - try again");
        } catch (err) {
          alert("Error: " + err.message);
        }
      }

      function stopScan() {
        scanning = false;
        statusEl.textContent = "Stopped";
        statusEl.className = "badge bg-secondary";
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }

      function handleRead(batchId) {
        const time = Date.now();
        lastBatch.textContent = batchId;
        lastTime.textContent = fmt(time);
        batchInput.value = batchId;
        history.unshift({
          timestamp: time,
          batchId,
          farmer: "",
          qty: "",
          notes: "",
        });
        saveHistory();
      }

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        if (!batchInput.value) return alert("Batch ID required!");
        const data = {
          timestamp: Date.now(),
          batchId: batchInput.value,
          farmer: farmerInput.value,
          qty: qtyInput.value,
          notes: notesInput.value,
        };
        history.unshift(data);
        saveHistory();
        form.reset();
        lastBatch.textContent = data.batchId;
        lastTime.textContent = fmt(data.timestamp);
      });

      demoBtn.onclick = () => handleRead("BATCH-DEMO-001");
      startBtn.onclick = startScan;
      stopBtn.onclick = stopScan;

      exportBtn.onclick = () => {
        if (history.length === 0) return alert("No data to export");
        const headers = ["Timestamp", "Batch ID", "Farmer", "Qty", "Notes"];
        const rows = history.map((h) => [
          fmt(h.timestamp),
          h.batchId,
          h.farmer,
          h.qty,
          h.notes,
        ]);
        const csv = [headers, ...rows]
          .map((r) =>
            r.map((v) => '"' + (v || "").replace(/\"/g, '""') + '"').join(",")
          )
          .join("\\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "nfc-batches.csv";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      };

      clearBtn.onclick = () => {
        if (confirm("Clear all history?")) {
          history = [];
          saveHistory();
        }
      };

      // Initial
      if (!supported) {
        noSupport.classList.remove("d-none");
        statusEl.textContent = "Not Supported";
        statusEl.className = "badge bg-danger";
      } else {
        statusEl.textContent = "Ready";
        statusEl.className = "badge bg-info";
      }
      renderHistory();
    </script>
  </body>
</html>
